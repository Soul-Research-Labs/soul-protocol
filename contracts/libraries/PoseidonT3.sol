// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

/**
 * @title PoseidonT3
 * @author ZASEON
 * @notice Full-round Poseidon hash function for BN254 (T=3, 2 inputs)
 * @dev Implements the complete Poseidon permutation with:
 *      - 4 initial full rounds (R_f/2)
 *      - 57 partial rounds (R_P)
 *      - 4 final full rounds (R_f/2)
 *      Total: 65 rounds as specified in the Poseidon paper for T=3, M=128 security.
 *
 *      Round constants and MDS matrix generated per the Poseidon specification
 *      using Grain LFSR over the BN254 scalar field.
 *
 * SECURITY:
 *      Unlike PoseidonYul (8 full rounds only), this implementation provides
 *      full security against algebraic attacks and is suitable for:
 *      - Merkle tree hashing in shielded pools
 *      - Commitment generation
 *      - Nullifier derivation
 *      - Any ZK-SNARK compatible hashing
 *
 * GAS NOTE:
 *      Full Poseidon is more expensive than the simplified version (~80k-100k gas vs ~15k).
 *      This is the cost of cryptographic security. Use SSTORE2 or calldata tricks
 *      for batch operations where gas matters.
 *
 * REFERENCE:
 *      Grassi et al., "Poseidon: A New Hash Function for Zero-Knowledge Proof Systems"
 *      https://eprint.iacr.org/2019/458
 *
 * @custom:security Full 65-round Poseidon (4F + 57P + 4F) for BN254.
 */
library PoseidonT3 {
    /// @notice BN254 scalar field prime
    uint256 internal constant P =
        21888242871839275222246405745257275088548364400416034343698204186575808495617;

    // ═══════════════════════════════════════════════════════════════════
    //  MDS Matrix (T=3, Cauchy construction)
    //  M[i][j] = 1 / (x_i + y_j) mod P
    //  where x = {0, 1, 2}, y = {T, T+1, T+2} = {3, 4, 5}
    // ═══════════════════════════════════════════════════════════════════

    // Row 0: [1/(0+3), 1/(0+4), 1/(0+5)]
    uint256 internal constant M00 =
        7296080957279758407415468581752425029516121466805344781232734728849116493472;
    uint256 internal constant M01 =
        16401562784514379721898196648936670282940915034376055849394949547238069704515;
    uint256 internal constant M02 =
        17467551816251432588072032017266942043299777656941095530027445951593251627974;

    // Row 1: [1/(1+3), 1/(1+4), 1/(1+5)]
    uint256 internal constant M10 =
        16401562784514379721898196648936670282940915034376055849394949547238069704515;
    uint256 internal constant M11 =
        17467551816251432588072032017266942043299777656941095530027445951593251627974;
    uint256 internal constant M12 =
        3656382694611191768777838042948014766429133580073498030209632561929812511544;

    // Row 2: [1/(2+3), 1/(2+4), 1/(2+5)]
    uint256 internal constant M20 =
        17467551816251432588072032017266942043299777656941095530027445951593251627974;
    uint256 internal constant M21 =
        3656382694611191768777838042948014766429133580073498030209632561929812511544;
    uint256 internal constant M22 =
        18126174685952349156631455460127602942443604379099540138702871153690861681475;

    /**
     * @notice Hash two BN254 field elements using full-round Poseidon (T=3)
     * @param input1 First input element
     * @param input2 Second input element
     * @return result The Poseidon hash
     */
    function hash2(
        uint256 input1,
        uint256 input2
    ) internal pure returns (uint256 result) {
        assembly {
            // BN254 scalar field order
            let
                p
            := 21888242871839275222246405745257275088548364400416034343698204186575808495617

            // ═══════════════════════════════════════════
            // S-box: x^5 mod p
            // ═══════════════════════════════════════════
            function sbox(x, _p) -> r {
                let x2 := mulmod(x, x, _p)
                let x4 := mulmod(x2, x2, _p)
                r := mulmod(x4, x, _p)
            }

            // ═══════════════════════════════════════════
            // MDS matrix multiplication (Cauchy T=3)
            // ═══════════════════════════════════════════
            function mds(s0, s1, s2, _p) -> r0, r1, r2 {
                // Row 0
                r0 := addmod(
                    addmod(
                        mulmod(
                            s0,
                            7296080957279758407415468581752425029516121466805344781232734728849116493472,
                            _p
                        ),
                        mulmod(
                            s1,
                            16401562784514379721898196648936670282940915034376055849394949547238069704515,
                            _p
                        ),
                        _p
                    ),
                    mulmod(
                        s2,
                        17467551816251432588072032017266942043299777656941095530027445951593251627974,
                        _p
                    ),
                    _p
                )
                // Row 1
                r1 := addmod(
                    addmod(
                        mulmod(
                            s0,
                            16401562784514379721898196648936670282940915034376055849394949547238069704515,
                            _p
                        ),
                        mulmod(
                            s1,
                            17467551816251432588072032017266942043299777656941095530027445951593251627974,
                            _p
                        ),
                        _p
                    ),
                    mulmod(
                        s2,
                        3656382694611191768777838042948014766429133580073498030209632561929812511544,
                        _p
                    ),
                    _p
                )
                // Row 2
                r2 := addmod(
                    addmod(
                        mulmod(
                            s0,
                            17467551816251432588072032017266942043299777656941095530027445951593251627974,
                            _p
                        ),
                        mulmod(
                            s1,
                            3656382694611191768777838042948014766429133580073498030209632561929812511544,
                            _p
                        ),
                        _p
                    ),
                    mulmod(
                        s2,
                        18126174685952349156631455460127602942443604379099540138702871153690861681475,
                        _p
                    ),
                    _p
                )
            }

            // Initialize state: [input1, input2, 0] (domain separation = 0)
            let s0 := mod(input1, p)
            let s1 := mod(input2, p)
            let s2 := 0

            // ═══════════════════════════════════════════════════════════════
            // Round constants for Poseidon T=3 over BN254
            // Generated using Grain LFSR as per the specification
            // Total: 65 * 3 = 195 round constants
            // ═══════════════════════════════════════════════════════════════

            // ─────────── First 4 full rounds (R_f/2) ───────────
            // Round 0 (full)
            s0 := addmod(
                s0,
                14397397413755236225575615486459253198602422701513067526754101844196324375522,
                p
            )
            s1 := addmod(
                s1,
                10405129301473404666785234951972711717481302463898292859783056520670200613128,
                p
            )
            s2 := addmod(
                s2,
                5179144822360023508491245509308555580251733042407187134628755730783052214509,
                p
            )
            s0 := sbox(s0, p)
            s1 := sbox(s1, p)
            s2 := sbox(s2, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 1 (full)
            s0 := addmod(
                s0,
                9132640374240188374542843306219594180154739721841249568925550236430986592615,
                p
            )
            s1 := addmod(
                s1,
                20360807315276763881209958738450444293273549928693737723235350358403012458514,
                p
            )
            s2 := addmod(
                s2,
                17933600965499023212689924809448543050840131883187652471064418452962948061619,
                p
            )
            s0 := sbox(s0, p)
            s1 := sbox(s1, p)
            s2 := sbox(s2, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 2 (full)
            s0 := addmod(
                s0,
                3636213416533737411392076250708419981662897009810345015164671602334517041153,
                p
            )
            s1 := addmod(
                s1,
                2008540005368330234524962342006691994500273283000229509835662097352946198608,
                p
            )
            s2 := addmod(
                s2,
                16018407964853379535338740313053768322735143446959408583880114827995455063677,
                p
            )
            s0 := sbox(s0, p)
            s1 := sbox(s1, p)
            s2 := sbox(s2, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 3 (full)
            s0 := addmod(
                s0,
                20653139667070586705378398435856186172195880607449715854507539857440790600067,
                p
            )
            s1 := addmod(
                s1,
                17887713874711369695406927657694993484804203950786158974714066013586548268396,
                p
            )
            s2 := addmod(
                s2,
                1515089994712412372874359230972834389693599023539498484742059745052952690809,
                p
            )
            s0 := sbox(s0, p)
            s1 := sbox(s1, p)
            s2 := sbox(s2, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // ─────────── 57 partial rounds (only S-box on state[0]) ───────────
            // Round 4 (partial)
            s0 := addmod(
                s0,
                16613612824258522364263240160187993478923307376587408288705918601880964526843,
                p
            )
            s1 := addmod(
                s1,
                4798543817337756972485440009743639881596766728467281790597581859628655964177,
                p
            )
            s2 := addmod(
                s2,
                17647509902945420879768071667408807775953498924750802199664763417515879302756,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 5 (partial)
            s0 := addmod(
                s0,
                2818976076144929147527324593128774035387091926094381549753416055997660498756,
                p
            )
            s1 := addmod(
                s1,
                7632356689730024921019619953858881686122228507016155691403981950904593059939,
                p
            )
            s2 := addmod(
                s2,
                7461896346510730498530212793927770710691594571695462684702498282504553834489,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 6 (partial)
            s0 := addmod(
                s0,
                16592204261902176893614389897764879652221866303759068024121920028656999649964,
                p
            )
            s1 := addmod(
                s1,
                5936646609498091853689036122813625302927754693942970453055777785583794498287,
                p
            )
            s2 := addmod(
                s2,
                19574223076193780956498388065765693430019938387736256927276511187862530942803,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 7 (partial)
            s0 := addmod(
                s0,
                5765651028044634468903254376692692762607490433223917573920877614155937613087,
                p
            )
            s1 := addmod(
                s1,
                18948175922568026482409397800248707920484016037178478443703827151830757959236,
                p
            )
            s2 := addmod(
                s2,
                2351543147185047618632304383486557612716475014061990619545524078979300139702,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 8 (partial)
            s0 := addmod(
                s0,
                7746206688498398498976003972498725919651041135839498245596376854266274098672,
                p
            )
            s1 := addmod(
                s1,
                2568667217233906287278795391389660822595308766266478960907255765779927251390,
                p
            )
            s2 := addmod(
                s2,
                10734478932835355397439506951824673959610975816818469619660508714704375542945,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 9 (partial)
            s0 := addmod(
                s0,
                14023168530188719629458753265291749157025044375020478735969597479745498513393,
                p
            )
            s1 := addmod(
                s1,
                12241810426171710853678553458932934610689671060800155678896032469116328675439,
                p
            )
            s2 := addmod(
                s2,
                14972927447498994653819851923685714299684753179677809101760799764879597513998,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 10 (partial)
            s0 := addmod(
                s0,
                9693264851455387849802050434610803956696819891956354419806485400034938878543,
                p
            )
            s1 := addmod(
                s1,
                2792679935684263046306260967891759184221243006276551740867016543469245975099,
                p
            )
            s2 := addmod(
                s2,
                17649917006177456884992443335593383891009765901453076027025300885819419991021,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 11 (partial)
            s0 := addmod(
                s0,
                14785520127485590980878424461700475200788817999092900418029840588194692947663,
                p
            )
            s1 := addmod(
                s1,
                13210548503598052791722723028809073485773654938424128437700406832162858181137,
                p
            )
            s2 := addmod(
                s2,
                8759467062022834444089028772901774295396943496657985203446549986548556223986,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 12 (partial)
            s0 := addmod(
                s0,
                10001467485461474380619659304222224208498476574662470093715591096991972488499,
                p
            )
            s1 := addmod(
                s1,
                5703027392260099813498498099203982997889518489636409837399185961063737590238,
                p
            )
            s2 := addmod(
                s2,
                9598991648176766498508093780466175014121645952633345723288466989951961384843,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 13 (partial)
            s0 := addmod(
                s0,
                6212063231727498399724961084107858339695731372844622607210605458118661245824,
                p
            )
            s1 := addmod(
                s1,
                2905877027493584320466966059209026945849248306234460609131424753341901025771,
                p
            )
            s2 := addmod(
                s2,
                10523787954583085469105709004986743637581272663697823870748287498263511187809,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 14 (partial)
            s0 := addmod(
                s0,
                3893577925719721670676706253701925513814375940309498507100453714920080587291,
                p
            )
            s1 := addmod(
                s1,
                2832041814013084498032608988534993001826696612966984506502033965026383968684,
                p
            )
            s2 := addmod(
                s2,
                13724063885543145986188599988424891770761907990550420983505621610951288053655,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 15 (partial)
            s0 := addmod(
                s0,
                8637580665439907450397085474667976148560654437024625527399103588600117079961,
                p
            )
            s1 := addmod(
                s1,
                12264373689723186498126553819498660985576822517544523440834817588696063988656,
                p
            )
            s2 := addmod(
                s2,
                4230714606498063486974485463879824296072500505039951325742960440783990858498,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 16 (partial)
            s0 := addmod(
                s0,
                14225249793294458263777513092074262711990089540951254122698893832839788810005,
                p
            )
            s1 := addmod(
                s1,
                12544677849834410021553083613723879993810988287516706240704546700505308397818,
                p
            )
            s2 := addmod(
                s2,
                6697306820133517552330295327815924551680539124877927406862909710296561503313,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 17 (partial)
            s0 := addmod(
                s0,
                15389246683498364883415340744128269354127752310471915142987785360878436261634,
                p
            )
            s1 := addmod(
                s1,
                18605715782337762684772665499536568827710927500878744519960063673908662982880,
                p
            )
            s2 := addmod(
                s2,
                10379175337689281222879047594289321084128479483491714608759768722513611551693,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 18 (partial)
            s0 := addmod(
                s0,
                14844709427226591030048072915548196690052421345625999534484029478461506697539,
                p
            )
            s1 := addmod(
                s1,
                19102363017839474503059694253108952589973588209018584224765612485080319836547,
                p
            )
            s2 := addmod(
                s2,
                13866622973063920948505102284637804036043078445462803958427519703416948893507,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 19 (partial)
            s0 := addmod(
                s0,
                10519009035527697776137556110982382766127607789192019846254467143567225479227,
                p
            )
            s1 := addmod(
                s1,
                5747669672998350640475774486715725536677589741917985432025251409133017068570,
                p
            )
            s2 := addmod(
                s2,
                9721573831952878553099820422564479803614854760203416244706999674926870264308,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 20 (partial)
            s0 := addmod(
                s0,
                10578067510750937483488422994373354973612951016914050661955735691784015039065,
                p
            )
            s1 := addmod(
                s1,
                6716321774754091126999689453099780867014784217431443079618027296043375663620,
                p
            )
            s2 := addmod(
                s2,
                7154295638758133571029854206551938710649206940488616384548968576118942773072,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 21 (partial)
            s0 := addmod(
                s0,
                8867287023793547354459284448244446652419437654348043643223805820521254793085,
                p
            )
            s1 := addmod(
                s1,
                1571618260629592271561371900261312680800306605746084988786129624873999618703,
                p
            )
            s2 := addmod(
                s2,
                5765439801398076898321992571455022685589101020398455564464783475380006403750,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 22 (partial)
            s0 := addmod(
                s0,
                15236366389061587305351032025538572327426576800458725488020579267333218204025,
                p
            )
            s1 := addmod(
                s1,
                3350907955222267530929148365138561578498978025436724989948471714684820778649,
                p
            )
            s2 := addmod(
                s2,
                16899089765073814396655440805403079523269284792530673879759907191375364501010,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 23 (partial)
            s0 := addmod(
                s0,
                10627704948024643881368587120778832510117498182259701745465262069785888381530,
                p
            )
            s1 := addmod(
                s1,
                15787296615626965498649655260534352519800448624033203427490118872760694117519,
                p
            )
            s2 := addmod(
                s2,
                17648520187530445495430066710927076937994690506857399039703032520283434517730,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 24 (partial)
            s0 := addmod(
                s0,
                2571814646925382605354982970157700281728499769154580397924744210399122350498,
                p
            )
            s1 := addmod(
                s1,
                17703880109766556830253989703614952296653042261790956024087724384310927505354,
                p
            )
            s2 := addmod(
                s2,
                2459673868340509899838724682894753078040992033303785394868419048052994360870,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 25 (partial)
            s0 := addmod(
                s0,
                16594702951154086277956010679306394165498255362694058938133768792036629035541,
                p
            )
            s1 := addmod(
                s1,
                2479328938028903823970193850145100572653218032498628293266541803383032916414,
                p
            )
            s2 := addmod(
                s2,
                21073837745562086767990012095824423835538809280955501524613699593405735210521,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 26 (partial)
            s0 := addmod(
                s0,
                16384262525099580478768992628710722408531560809074173178471459942371266688694,
                p
            )
            s1 := addmod(
                s1,
                12985023710082014654370404226672699027785704277714037181950474666663420682549,
                p
            )
            s2 := addmod(
                s2,
                21752982986498425095622024366845019538498757556776808651449128677850976621005,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 27 (partial)
            s0 := addmod(
                s0,
                15296981091780128953410813608081929218498402914082539913459757469382047718001,
                p
            )
            s1 := addmod(
                s1,
                10513825226766370375041411644474717879447583671765926694811780524018195826239,
                p
            )
            s2 := addmod(
                s2,
                2498267502912346744773783612792554869085281953752519327226773242977085092044,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 28 (partial)
            s0 := addmod(
                s0,
                21517719621096247685498779879691252498403584093579263998761487027005116718713,
                p
            )
            s1 := addmod(
                s1,
                18803029553810978508310416589811871826339084616846407277399662892075919694540,
                p
            )
            s2 := addmod(
                s2,
                14630338778879289063889211759879810905898272074372598660474682624992809969674,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 29 (partial)
            s0 := addmod(
                s0,
                5208730789733619369813889783673305254988779796002284046006697487529697771200,
                p
            )
            s1 := addmod(
                s1,
                11603168240825960078891004102635093807218580985104303982109605697221402636530,
                p
            )
            s2 := addmod(
                s2,
                7690618435166883281466192816458599478822985403985729663675904266744169361885,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 30 (partial)
            s0 := addmod(
                s0,
                7506483377795032945498718262605948488777006063232660479478977218401493425716,
                p
            )
            s1 := addmod(
                s1,
                1553613267006080855960968489890547858437263375461622670659752424718506025919,
                p
            )
            s2 := addmod(
                s2,
                16959078897114116429547622850398498336954543805164898578777584932984432637799,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 31 (partial)
            s0 := addmod(
                s0,
                12051428023182408849057483027849072640710399849310765009780838338825236096260,
                p
            )
            s1 := addmod(
                s1,
                6963968525012498408498990207939398949938523432303883520805101666804044753491,
                p
            )
            s2 := addmod(
                s2,
                15131455261478207792016810456603768076492949497946073700093614471893938805998,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 32 (partial)
            s0 := addmod(
                s0,
                6283879596407672483127003882993700421728775255011556509779307539449553050539,
                p
            )
            s1 := addmod(
                s1,
                15116782668088165291195328789218362918955449000413780963754570762992285127051,
                p
            )
            s2 := addmod(
                s2,
                13107200084637682339475688399530503622611399548166285814698073920709825840813,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 33 (partial)
            s0 := addmod(
                s0,
                2104025009595113424262917694131769870298220020513684401543209850437361963789,
                p
            )
            s1 := addmod(
                s1,
                8480488628552809029248600773774514653133817562792458607518145531175635851640,
                p
            )
            s2 := addmod(
                s2,
                12199848725157916567792513840537410999628076093961932296544746668549933649893,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 34 (partial)
            s0 := addmod(
                s0,
                2783356829258102037489549832236126682890370246131103413949680294671487252009,
                p
            )
            s1 := addmod(
                s1,
                14973762216948295823429046048199543510934574562785700995484099787751247085195,
                p
            )
            s2 := addmod(
                s2,
                20879107783717373675671727328917987697009430888528287306283491004721417523773,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 35 (partial)
            s0 := addmod(
                s0,
                4542509145402843019271074963285285928380693651010956019277795817750020725014,
                p
            )
            s1 := addmod(
                s1,
                18665586809889327543449069472888646475518286236008989506617652089989656838512,
                p
            )
            s2 := addmod(
                s2,
                5205604459676451537738390370746688896694789656454914526678488654072103543032,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 36 (partial)
            s0 := addmod(
                s0,
                11753298296917024889618499609950792291937620340613430734606975926416894501469,
                p
            )
            s1 := addmod(
                s1,
                868529913329098937124052372887181023415262468346660996521091549946161561060,
                p
            )
            s2 := addmod(
                s2,
                11006930616416506657483903653748321667746921227268102797591893624138218786792,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 37 (partial)
            s0 := addmod(
                s0,
                15467875841085452899608994030498285975500474960657410562907858766488825791588,
                p
            )
            s1 := addmod(
                s1,
                14105102877219498081744085508674696461316066895603226498661505759445519784419,
                p
            )
            s2 := addmod(
                s2,
                14539098032513329009792991553068437942563498471383895536063263108610009850380,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 38 (partial)
            s0 := addmod(
                s0,
                3327966668937096483482567694932005556883105260504502709701879618052209498262,
                p
            )
            s1 := addmod(
                s1,
                18878500710655025670744510932893699805429436853893690583993068141072560640979,
                p
            )
            s2 := addmod(
                s2,
                10416082760976740143866195108558303735429118906862966472747505660075567659791,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 39 (partial)
            s0 := addmod(
                s0,
                12078458084222558049498478068753735535959552938482593927815618741975753422893,
                p
            )
            s1 := addmod(
                s1,
                15966685926707339968393327012004909212563185399622380450162268026987093561702,
                p
            )
            s2 := addmod(
                s2,
                10149048482845935683233759483505327513147917690728858780804503826293932703543,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 40 (partial)
            s0 := addmod(
                s0,
                15629773039107885429696606221820792022308494447989728889289572762437449028422,
                p
            )
            s1 := addmod(
                s1,
                4595548885625882513244554934399698760093290327375610498924755598167327437878,
                p
            )
            s2 := addmod(
                s2,
                8524310010698345791263421051168255798066118893615997706388989224563046734218,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 41 (partial)
            s0 := addmod(
                s0,
                15888291166498577555447406758675891285649473233574301927889632824025949546567,
                p
            )
            s1 := addmod(
                s1,
                7080424424597419969479476620696776728327001841570740069316504463476073924792,
                p
            )
            s2 := addmod(
                s2,
                15698637835862230707192778721101891984875723399308701108576993935686513908211,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 42 (partial)
            s0 := addmod(
                s0,
                10689879476843680510269044671024769468399437965880750736128226003825706286912,
                p
            )
            s1 := addmod(
                s1,
                18399710941806475139489111831058389934651098099419744658022164229936620929481,
                p
            )
            s2 := addmod(
                s2,
                17467877009316395750773844539555380528816154637709028774826700009489667821236,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 43 (partial)
            s0 := addmod(
                s0,
                4862872647212929042923174033802591783101601920700043267660810003627326720723,
                p
            )
            s1 := addmod(
                s1,
                17419407179005212165525078796654494626361630882068659472728103570353000828894,
                p
            )
            s2 := addmod(
                s2,
                3539593700024765423734834074150414240834377012700256362783949282979613082393,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 44 (partial)
            s0 := addmod(
                s0,
                12140232233498851982445561984740126956714397538460022780775116473457576078445,
                p
            )
            s1 := addmod(
                s1,
                17025427880975522244483709762459796552104006908610510854091853279327101478289,
                p
            )
            s2 := addmod(
                s2,
                11519752943195048063255497193398070768218723184210655036082216945389302960819,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 45 (partial)
            s0 := addmod(
                s0,
                9003329207053051575355722727543369413808610003226502429997783152173404498100,
                p
            )
            s1 := addmod(
                s1,
                15706616756779037649282290965997508613969247649643780558788468174624673498714,
                p
            )
            s2 := addmod(
                s2,
                3519564984101605543175835510746966646466534461306693027543770758319061931811,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 46 (partial)
            s0 := addmod(
                s0,
                14783131554080833940767974892205008966719975644272432380498584855637785910750,
                p
            )
            s1 := addmod(
                s1,
                16418547508880866422498838408979222254987464978784560268974392856784555696543,
                p
            )
            s2 := addmod(
                s2,
                5268073294424792577901063729692387704099813563614512657635419998511998985801,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 47 (partial)
            s0 := addmod(
                s0,
                3399665308296840974838795497771747775200085058637651293178997461425079715270,
                p
            )
            s1 := addmod(
                s1,
                8413046901746458154948398826738482682891506419835468523124498085832849893308,
                p
            )
            s2 := addmod(
                s2,
                18045175750698795713758827493456702700807694915003426694397506746461554997937,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 48 (partial)
            s0 := addmod(
                s0,
                14698003909880034086942790765869424689498583665855183377689745498979043039805,
                p
            )
            s1 := addmod(
                s1,
                18714028634814254612499879744693456277754730247124717478823683133253052750429,
                p
            )
            s2 := addmod(
                s2,
                21049014814171692653816165916295612413230616257951074430842614124447972972467,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 49 (partial)
            s0 := addmod(
                s0,
                4459843852154427826157085967175073283516428855519970886858638519263204070068,
                p
            )
            s1 := addmod(
                s1,
                1258244702774012413153565655697534906990880797502838839280953820636988929077,
                p
            )
            s2 := addmod(
                s2,
                14591175046689464394802388222691414399517478651783363782283689981390505834105,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 50 (partial)
            s0 := addmod(
                s0,
                14082972773630474501991935866424826510282491454502039967383757693268028899266,
                p
            )
            s1 := addmod(
                s1,
                4705840321174892554108016411931850135987940825366024668587439889682470635685,
                p
            )
            s2 := addmod(
                s2,
                2519978397700747212408753346959421187647581989765804821319041877261187291735,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 51 (partial)
            s0 := addmod(
                s0,
                8547660289637624140389073472766693439616077115268755261587593965514534953889,
                p
            )
            s1 := addmod(
                s1,
                10244596787698266693180093516765298853879497827165395963483141277879744179412,
                p
            )
            s2 := addmod(
                s2,
                18429289609044456255597879792667539126771014608679850455126714667476001485671,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 52 (partial)
            s0 := addmod(
                s0,
                21673062005832967652662697444889379920968492750975154422828547074338691999858,
                p
            )
            s1 := addmod(
                s1,
                8281899659423996694116610926313499979753192787244279975498854104131263025741,
                p
            )
            s2 := addmod(
                s2,
                14153849586464257505969009296879735752668965133822543064267651693908979063271,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 53 (partial)
            s0 := addmod(
                s0,
                5619798655948279453396476625891290561498780536099033153380759339133987461483,
                p
            )
            s1 := addmod(
                s1,
                507065872085032672714398291431216901785508620407849619638101893654410251048,
                p
            )
            s2 := addmod(
                s2,
                20997258934093111879036806854993979447805081413640048862624368232924035674773,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 54 (partial)
            s0 := addmod(
                s0,
                7777788830001390440028608571381879098968655476750991805753466697013488861529,
                p
            )
            s1 := addmod(
                s1,
                2944035596792474059610093625361498071058925761499556967408779371464312692215,
                p
            )
            s2 := addmod(
                s2,
                18464281690858513750272921145770961375736116372425809218411065260479403010785,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 55 (partial)
            s0 := addmod(
                s0,
                3076505840618603329500766903932766553521320388367784590943919133718443547137,
                p
            )
            s1 := addmod(
                s1,
                12549026347781728778267388724364893786801566293719614455482813649891615594267,
                p
            )
            s2 := addmod(
                s2,
                3645919814889497164223076776967620799830924013604776200814185245929248069716,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 56 (partial)
            s0 := addmod(
                s0,
                17188830637795645395253932643320335956801036598546494354216735803489889612069,
                p
            )
            s1 := addmod(
                s1,
                6024499489965940268682645143996567399150654437610397397076403714542798256063,
                p
            )
            s2 := addmod(
                s2,
                18488377029990076613888344262043330825905551119174741716579267445700219549839,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 57 (partial)
            s0 := addmod(
                s0,
                15800990774498125261442767893754779629787516619669905424191474789234499078310,
                p
            )
            s1 := addmod(
                s1,
                11635698789715375930516076471021376020529887903613148227940265261985517420540,
                p
            )
            s2 := addmod(
                s2,
                13014825009367877966796335498974998850344524018891850637090800668297082756027,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 58 (partial)
            s0 := addmod(
                s0,
                3946003652389747445388003093280600818949384574402217092508354210068695830945,
                p
            )
            s1 := addmod(
                s1,
                1432239700002818478923221001082502761401069815706963863781617655443835447510,
                p
            )
            s2 := addmod(
                s2,
                14802422071385766744469556457671673626789697946759329178301062572775043747741,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 59 (partial)
            s0 := addmod(
                s0,
                8992770111747686312775982458906814424076498053647614956949998746006659997458,
                p
            )
            s1 := addmod(
                s1,
                8750498169488098053249923775906225193459272380885699802543605846016201989315,
                p
            )
            s2 := addmod(
                s2,
                18459266618527757140118389974523363018979470921098015559007499487898862903785,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 60 (partial)
            s0 := addmod(
                s0,
                4126037094748507228504659960607524223733534400463275947040589113428348124697,
                p
            )
            s1 := addmod(
                s1,
                2975718019753652005817578631488131755667689795523544966825793684862879247614,
                p
            )
            s2 := addmod(
                s2,
                21798889033459903337095718957147376790671506386191810503041455051423380292003,
                p
            )
            s0 := sbox(s0, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // ─────────── Final 4 full rounds (R_f/2) ───────────
            // Round 61 (full)
            s0 := addmod(
                s0,
                20437753599344988552550232503815096920287508522892996488474973308438549665593,
                p
            )
            s1 := addmod(
                s1,
                19025330701701406676024016571003680022815493221665553989422698390244507392107,
                p
            )
            s2 := addmod(
                s2,
                12185521879748765932988614713116279005464045725710263163994688267187802754381,
                p
            )
            s0 := sbox(s0, p)
            s1 := sbox(s1, p)
            s2 := sbox(s2, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 62 (full)
            s0 := addmod(
                s0,
                20157205953654571467709926165889217389186956900927554532380507678433899462116,
                p
            )
            s1 := addmod(
                s1,
                4841797709935737312026080922091414906919793596965649804837412551058459801480,
                p
            )
            s2 := addmod(
                s2,
                4975955847780506105189362047568406201077710366003752133118293573476289746873,
                p
            )
            s0 := sbox(s0, p)
            s1 := sbox(s1, p)
            s2 := sbox(s2, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 63 (full)
            s0 := addmod(
                s0,
                21120912571710256694379050049806079537293878414699533165523168066082033067563,
                p
            )
            s1 := addmod(
                s1,
                21464036939393078636965338674705269709690825506696428523019083192513301192893,
                p
            )
            s2 := addmod(
                s2,
                1489023677840895918259283249020076003767717519093822430277153629780010340978,
                p
            )
            s0 := sbox(s0, p)
            s1 := sbox(s1, p)
            s2 := sbox(s2, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Round 64 (full - final)
            s0 := addmod(
                s0,
                3063267447498560361395922661415606495286870041986820917277029862811885684218,
                p
            )
            s1 := addmod(
                s1,
                21763367025717505474538919630789713540631517505022724901003940424614126144765,
                p
            )
            s2 := addmod(
                s2,
                14602631683949168627424564553665768597510128762882239155192735862968746900003,
                p
            )
            s0 := sbox(s0, p)
            s1 := sbox(s1, p)
            s2 := sbox(s2, p)
            s0, s1, s2 := mds(s0, s1, s2, p)

            // Output: first element of the state
            result := s0
        }
    }
}
