name: Release

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v2.1.0)"
        required: true
        type: string
      prerelease:
        description: "Mark as pre-release"
        required: false
        type: boolean
        default: false

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: "20"

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Release version: $VERSION"

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build contracts
        run: forge build

      - name: Run core tests
        run: forge test --no-match-path 'test/stress/*' -vvv

      - name: Check contract sizes
        run: |
          forge build --sizes 2>&1 | tee /tmp/sizes.txt
          if awk -F'|' '/\|/ && NR>3 { gsub(/[ \t]/, "", $3); if ($3+0 > 24.576) { print "FAIL: " $2 " size=" $3 "KB"; found=1 } } END { exit (found ? 1 : 0) }' /tmp/sizes.txt; then
            echo "✅ All contracts within EIP-170 limit"
          else
            echo "❌ Contract size limit exceeded"
            exit 1
          fi

  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.validate.outputs.version }}"

          # Get previous tag
          PREV_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]' | head -2 | tail -1)
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "Generating changelog from $PREV_TAG to HEAD"

          # Generate structured changelog
          {
            echo "# ${VERSION}"
            echo ""
            echo "## Changes"
            echo ""

            # Categorize commits
            echo "### Contracts"
            git log "${PREV_TAG}..HEAD" --pretty=format:"- %s (%h)" -- 'contracts/' | head -50
            echo ""
            echo ""

            echo "### ZK Circuits (Noir)"
            git log "${PREV_TAG}..HEAD" --pretty=format:"- %s (%h)" -- 'noir/' | head -20
            echo ""
            echo ""

            echo "### SDK"
            git log "${PREV_TAG}..HEAD" --pretty=format:"- %s (%h)" -- 'sdk/' | head -20
            echo ""
            echo ""

            echo "### Tests"
            git log "${PREV_TAG}..HEAD" --pretty=format:"- %s (%h)" -- 'test/' | head -20
            echo ""
            echo ""

            echo "### Infrastructure & CI"
            git log "${PREV_TAG}..HEAD" --pretty=format:"- %s (%h)" -- '.github/' 'scripts/' 'foundry.toml' 'hardhat.config.ts' | head -20
            echo ""
            echo ""

            echo "### Documentation"
            git log "${PREV_TAG}..HEAD" --pretty=format:"- %s (%h)" -- 'docs/' | head -20
            echo ""
            echo ""

            echo "---"
            echo ""
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${VERSION}"
          } > CHANGELOG_RELEASE.md

          cat CHANGELOG_RELEASE.md

          # Set output (multiline)
          {
            echo "changelog<<EOF"
            cat CHANGELOG_RELEASE.md
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  build-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build contracts
        run: forge build

      - name: Generate ABIs
        run: |
          mkdir -p release-artifacts/abis
          # Extract ABIs from core contracts
          for contract in SoulProtocolHub CrossChainProofHubV3 MultiBridgeRouter \
            ZKBoundStateLocks NullifierRegistryV3 StealthAddressRegistry \
            ProofCarryingContainer UniversalShieldedPool PrivacyRouter \
            SoulGovernor SoulToken; do
            ABI_FILE=$(find out/ -name "${contract}.json" -path "*/out/*" | head -1)
            if [ -f "$ABI_FILE" ]; then
              jq '.abi' "$ABI_FILE" > "release-artifacts/abis/${contract}.json"
            fi
          done

      - name: Generate gas snapshot
        run: |
          forge snapshot --no-match-test "test_Attack_RelayerFrontRunning|test_storageOperations_atScale" > release-artifacts/gas-snapshot.txt 2>&1 || true

      - name: Build SDK
        run: |
          cd sdk && npm ci && npm run build
          cp -r dist/ ../release-artifacts/sdk-dist/ 2>/dev/null || echo "SDK dist not found"

      - name: Package release
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          tar -czf "soul-protocol-${VERSION}-artifacts.tar.gz" release-artifacts/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: soul-protocol-*-artifacts.tar.gz
          retention-days: 90

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, generate-changelog, build-artifacts]
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: "Soul Protocol ${{ needs.validate.outputs.version }}"
          body: ${{ needs.generate-changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ inputs.prerelease || false }}
          files: |
            soul-protocol-*-artifacts.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
