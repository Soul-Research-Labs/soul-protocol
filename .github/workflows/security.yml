name: Security Pipeline

permissions:
  contents: read

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security checks daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FOUNDRY_PROFILE: ci
  SOLC_VERSION: 0.8.24

jobs:
  # ============================================
  # Static Analysis
  # ============================================
  slither:
    name: Slither Static Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Build contracts
        run: forge build

      - name: Prepare SARIF output dir
        run: mkdir -p results

      - name: Run Slither
        uses: crytic/slither-action@v0.4.0
        id: slither
        with:
          node-version: '20'
          slither-config: slither.config.json
          sarif: results/slither.sarif
          fail-on: high
        continue-on-error: true

      - name: Upload Slither SARIF
        # don't even try if the file isn't there
        if: always() && hashFiles('results/slither.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results/slither.sarif

      - name: Check Slither Results
        if: steps.slither.outcome == 'failure'
        run: |
          echo "::error::Slither found high severity issues"
          exit 1

  solhint:
    name: Solhint Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Solhint
        run: npx solhint 'contracts/**/*.sol' --config .solhint.json

  # ============================================
  # Fuzz Testing
  # ============================================
  foundry-fuzz:
    name: Foundry Fuzz Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Fuzz Tests
        run: |
          forge test --match-path "test/fuzz/**" \
            --fuzz-runs 5000 \
            --fuzz-seed 42 \
            -vvv
        env:
          FOUNDRY_FUZZ_RUNS: 5000

      - name: Upload Test Results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: foundry-fuzz-results
          path: |
            cache/
            out/

  foundry-invariant:
    name: Foundry Invariant Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Invariant Tests
        run: |
          forge test --match-path "test/invariant/**" \
            --fuzz-runs 256 \
            --fuzz-depth 50 \
            -vvv
        env:
          FOUNDRY_INVARIANT_RUNS: 256
          FOUNDRY_INVARIANT_DEPTH: 50

  # ============================================
  # Echidna Property Testing
  # ============================================
  echidna:
    name: Echidna Property Testing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build contracts
        run: forge build

      - name: Install Echidna
        run: |
          curl -L https://github.com/crytic/echidna/releases/download/v2.2.4/echidna-2.2.4-x86_64-linux.tar.gz | tar xz
          sudo mv echidna /usr/local/bin/

      - name: Run Echidna - EchidnaTests
        run: |
          echidna contracts/test/EchidnaTests.sol \
            --contract EchidnaTests \
            --config echidna.yaml \
            --test-limit 50000
        continue-on-error: true

      - name: Run Echidna - EchidnaPQC
        run: |
          echidna contracts/test/echidna/EchidnaPQC.sol \
            --contract EchidnaPQC \
            --config echidna.yaml \
            --test-limit 50000
        continue-on-error: true

      - name: Run Echidna - EchidnaZKSlocksAdvanced
        run: |
          echidna contracts/test/echidna/EchidnaZKSlocksAdvanced.sol \
            --contract EchidnaZKSlocksAdvanced \
            --config echidna.yaml \
            --test-limit 50000
        continue-on-error: true

  # ============================================
  # Symbolic Execution
  # ============================================
  halmos:
    name: Halmos Symbolic Testing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          pip install halmos

      - name: Build contracts
        run: forge build

      - name: Run Halmos
        run: |
          halmos --solver-timeout-assertion 300000 \
            --solver-timeout-branching 30000 \
            --loop 5 \
            --depth 20 \
            --match-test "check_"
        continue-on-error: true

      - name: Upload Halmos Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: halmos-results
          path: halmos-out/

  # ============================================
  # Formal Verification - Certora
  # ============================================
  certora:
    name: Certora Formal Verification
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          pip install certora-cli

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Build contracts
        run: forge build

      - name: Run Certora - ZKBoundStateLocks
        run: certoraRun certora/conf/verify_zkslocks.conf
        env:
          CERTORAKEY: ${{ secrets.CERTORAKEY }}
        continue-on-error: true

      - name: Run Certora - Dilithium
        run: certoraRun certora/conf/verify_dilithium.conf
        env:
          CERTORAKEY: ${{ secrets.CERTORAKEY }}
        continue-on-error: true

      - name: Run Certora - Kyber
        run: certoraRun certora/conf/verify_kyber.conf
        env:
          CERTORAKEY: ${{ secrets.CERTORAKEY }}
        continue-on-error: true

      - name: Run Certora - PQCRegistry
        run: certoraRun certora/conf/verify_pqc_registry.conf
        env:
          CERTORAKEY: ${{ secrets.CERTORAKEY }}
        continue-on-error: true

  # ============================================
  # Mythril Deep Analysis
  # ============================================
  mythril:
    name: Mythril Symbolic Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build with Foundry
        run: forge build

      - name: Install Mythril
        run: pip install mythril

      - name: Run Mythril - Core Contracts
        run: |
          myth analyze contracts/primitives/ZKBoundStateLocks.sol \
            --solc-json remappings.json \
            --execution-timeout 300 \
            --max-depth 50 \
            --solver-timeout 60000 \
            || true

      - name: Run Mythril - PQC Contracts
        run: |
          myth analyze contracts/pqc/PQCRegistry.sol \
            --solc-json remappings.json \
            --execution-timeout 300 \
            --max-depth 50 \
            --solver-timeout 60000 \
            || true

  # ============================================
  # Dependency Security
  # ============================================
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: NPM Audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Check for known vulnerabilities
        run: npx better-npm-audit audit

  # ============================================
  # Gas Analysis
  # ============================================
  gas-report:
    name: Gas Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Gas Report
        run: forge test --gas-report > gas-report.txt

      - name: Upload Gas Report
        uses: actions/upload-artifact@v4
        with:
          name: gas-report
          path: gas-report.txt

      - name: Check Gas Limits
        run: |
          # Check for functions exceeding 500k gas
          if grep -E "│\s+[0-9]{6,}" gas-report.txt | grep -v "test"; then
            echo "::warning::Some functions use more than 500k gas"
          fi

  # ============================================
  # Security Summary
  # ============================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [slither, solhint, foundry-fuzz, foundry-invariant, echidna, halmos, dependency-audit]
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "## Security Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Slither | ${{ needs.slither.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Solhint | ${{ needs.solhint.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Foundry Fuzz | ${{ needs.foundry-fuzz.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Foundry Invariant | ${{ needs.foundry-invariant.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Echidna | ${{ needs.echidna.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Halmos | ${{ needs.halmos.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical checks failed
        if: needs.slither.result == 'failure' || needs.foundry-fuzz.result == 'failure' || needs.foundry-invariant.result == 'failure'
        run: |
          echo "::error::Critical security checks failed"
          exit 1
