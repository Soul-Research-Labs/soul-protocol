# Slither Static Analysis Report
# ZASEON — Per-Contract Analysis
# Date: 2026-02-10
# Slither version: 0.10.4 (crytic-compile 0.3.7)
# Config: slither.config.json (excludes: naming-convention, dead-code, solc-version, timestamp, constable-states, too-many-digits)
# Framework: Foundry with --via-ir

## Note
Full-project Slither analysis encounters a ConstantFolding assertion error
in generated verifier contracts (constants_folding.py:100). Per-contract
analysis works correctly and is used here for core contracts.

================================================================================
## Summary
================================================================================

| Contract                        | Findings | Severity Breakdown                           |
|---------------------------------|----------|----------------------------------------------|
| ZaseonProtocolHub                 |    0     | Clean                                        |
| L2ChainAdapter                  |    1     | 1 informational (assembly)                   |
| DirectL2Messenger               |    5     | 1 optimization (immutable), 4 informational  |
| CrossChainProofHubV3            |    8     | 2 medium (strict-eq), 1 optimization, 5 info |
| ConfidentialStateContainerV3    |    4     | 1 medium (strict-eq), 3 informational        |
| ZaseonAtomicSwapV2                |    7     | 1 medium (strict-eq), 1 low (reent-events), 5 info |
| NullifierRegistryV3             |    7     | 6 optimization (costly-loop), 1 info         |
| UniversalShieldedPool           |    9     | 1 high* (arbitrary-send-eth), 1 medium (zero-check), 7 info |
| StealthAddressRegistry          |    4     | 1 high* (arbitrary-send-eth), 1 medium (strict-eq), 2 info |
| ViewKeyRegistry                 |    2     | 2 medium (strict-eq)                         |
| BatchAccumulator                |    2     | 1 medium (strict-eq), 1 informational        |
| ZaseonCrossChainRelay             |    3     | 3 informational (low-level-calls)            |
| ZKBoundStateLocks               |    4     | 1 optimization (cyclomatic), 3 info          |
|---------------------------------|----------|----------------------------------------------|
| TOTAL                           |   56     | 0 critical, 2 high*, 8 medium, 1 low, 45 info/opt |

* high findings are `arbitrary-send-eth` — both are owner-only `withdrawFees`
  functions behind access control (onlyOwner). These are false positives in
  context since only the contract owner can specify the recipient.

================================================================================
## HIGH Findings (2) — False Positives (access-controlled)
================================================================================

### [H-1] StealthAddressRegistry.withdrawFees — arbitrary-send-eth
- File: contracts/privacy/StealthAddressRegistry.sol#885-896
- Detail: `withdrawFees(address,uint256)` sends ETH to arbitrary user
- Call: `(success,) = recipient.call{value: transferAmount}()`
- Mitigation: Function is `onlyOwner` — owner chooses recipient. FALSE POSITIVE.

### [H-2] UniversalShieldedPool._safeTransferETH — arbitrary-send-eth
- File: contracts/privacy/UniversalShieldedPool.sol#790-793
- Detail: `_safeTransferETH(address,uint256)` sends ETH to arbitrary user
- Call: `(success,) = to.call{value: amount}()`
- Mitigation: Internal function called only from withdrawal flow after proof
  verification. Recipient is the proven owner. FALSE POSITIVE.

================================================================================
## MEDIUM Findings (8) — Mostly Acceptable
================================================================================

### [M-1] SecurityModule.canWithdrawFlashLoanCheck — incorrect-equality
- File: contracts/security/SecurityModule.sol#614-630
- Detail: Strict equality `depositBlock == 0`
- Impact: By design — checks if deposit exists. ACCEPTABLE.

### [M-2] CrossChainProofHubV3.isProofFinalized — incorrect-equality
- File: contracts/bridge/CrossChainProofHubV3.sol#1044-1048
- Detail: Strict equality on enum `proofs[proofId].status == ProofStatus.Finalized`
- Impact: Enum comparison is correct usage. FALSE POSITIVE.

### [M-3] ConfidentialStateContainerV3.isStateActive — incorrect-equality
- File: contracts/core/ConfidentialStateContainerV3.sol#738-742
- Detail: Strict equality on enum `_states[commitment].status == StateStatus.Active`
- Impact: Enum comparison is correct. FALSE POSITIVE.

### [M-4] StealthAddressRegistry.registerMetaAddress — incorrect-equality
- File: contracts/privacy/StealthAddressRegistry.sol#327-362
- Detail: Strict equality on enum `metaAddresses[msg.sender].status == KeyStatus.ACTIVE`
- Impact: Enum comparison is correct. FALSE POSITIVE.

### [M-5-6] ViewKeyRegistry.getActiveGrantsReceived — incorrect-equality (x2)
- File: contracts/privacy/ViewKeyRegistry.sol#552-589
- Detail: Strict equality on enum `grants[...].status == GrantStatus.ACTIVE`
- Impact: Enum comparison is correct. FALSE POSITIVE.

### [M-7] BatchAccumulator.getAnonymitySet — incorrect-equality
- File: contracts/privacy/BatchAccumulator.sol#571-577
- Detail: Strict equality `batchId == bytes32(0)`
- Impact: Zero-check is correct usage. ACCEPTABLE.

### [M-8] UniversalShieldedPool.setSanctionsOracle — missing-zero-check
- File: contracts/privacy/UniversalShieldedPool.sol#551
- Detail: `_oracle` parameter lacks zero-address check
- Impact: Owner function, but should add zero-check.
- Recommendation: Add `require(_oracle != address(0))` or document that
  setting to address(0) disables sanctions checking.

================================================================================
## LOW Findings (1)
================================================================================

### [L-1] ZaseonAtomicSwapV2.executeFeeWithdrawal — reentrancy-events
- File: contracts/bridge/ZaseonAtomicSwapV2.sol#518-540
- Detail: Event emitted after external call
- Impact: Low — state is already updated before the call. Event ordering
  is cosmetic. ReentrancyGuard is applied.

================================================================================
## OPTIMIZATION Findings (8)
================================================================================

### [O-1] DirectL2Messenger.zaseonHub — immutable-states
- File: contracts/crosschain/DirectL2Messenger.sol#300
- Detail: `zaseonHub` should be declared `immutable`
- Recommendation: Change to `immutable` to save ~2100 gas per read.

### [O-2..7] NullifierRegistryV3 — costly-loop (x6)
- File: contracts/core/NullifierRegistryV3.sol
- Detail: State writes inside loops in `batchRegisterNullifiers` and
  `receiveCrossChainNullifiers` (merkleRoot, rootHistoryIndex, totalNullifiers)
- Impact: Gas inefficiency for large batches.
- Recommendation: Accumulate in memory, write once after loop. Consider
  max batch size limits.

### [O-8] ZKBoundStateLocks — cyclomatic-complexity
- File: contracts/primitives/ZKBoundStateLocks.sol
- Detail: High cyclomatic complexity in core functions.
- Recommendation: Refactor into smaller helper functions.

================================================================================
## INFORMATIONAL Findings (37)
================================================================================

Categories:
- assembly (4): L2ChainAdapter, DirectL2Messenger, ConfidentialStateContainerV3,
  NullifierRegistryV3 — all justified for gas optimization / hash operations
- low-level-calls (15): Across CrossChainProofHubV3, ZaseonAtomicSwapV2,
  DirectL2Messenger, UniversalShieldedPool, StealthAddressRegistry,
  BatchAccumulator, ZaseonCrossChainRelay, ZKBoundStateLocks — necessary for
  ETH transfers and dynamic verifier calls
- calls-loop (2): ConfidentialStateContainerV3 (verifier in batch),
  StealthAddressRegistry (batchScan) — by design for batch operations
- costly-loop (4): ConfidentialStateContainerV3, UniversalShieldedPool —
  state updates in batch/insertion loops
- unindexed-event-address (1): ZaseonAtomicSwapV2.FeeRecipientUpdated

================================================================================
## Per-Contract Details
================================================================================

### contracts/core/ZaseonProtocolHub.sol
  Analyzed: 7 contracts, 95 detectors
  Results: 0 — CLEAN

### contracts/crosschain/L2ChainAdapter.sol
  Analyzed: 10 contracts, 95 detectors
  Results: 1
  - assembly: _recoverSigner uses inline assembly (informational)

### contracts/crosschain/DirectL2Messenger.sol
  Analyzed: 18 contracts, 95 detectors
  Results: 5
  - assembly: configureRoute uses inline assembly
  - low-level-calls: _executeMessage, withdrawRelayerBond, resolveChallenge
  - immutable-states: zaseonHub should be immutable

### contracts/bridge/CrossChainProofHubV3.sol
  Analyzed: 10 contracts, 95 detectors
  Results: 8
  - incorrect-equality: isProofFinalized enum check, SecurityModule depositBlock
  - costly-loop: submitBatch ++totalProofs in loop
  - low-level-calls: withdrawStake, withdrawRewards, submitProofInstant,
    resolveChallenge, withdrawFees

### contracts/core/ConfidentialStateContainerV3.sol
  Analyzed: 16 contracts, 95 detectors
  Results: 4
  - incorrect-equality: isStateActive enum check
  - calls-loop: verifier.verifyProof in batchRegisterStates
  - assembly: _recordTransitionHistory
  - costly-loop: _packedCounters in batch loop

### contracts/bridge/ZaseonAtomicSwapV2.sol
  Analyzed: 10 contracts, 95 detectors
  Results: 7
  - incorrect-equality: SecurityModule.canWithdrawFlashLoanCheck
  - reentrancy-events: executeFeeWithdrawal event after call
  - low-level-calls: revealClaim, claim, refund, executeFeeWithdrawal
  - unindexed-event-address: FeeRecipientUpdated

### contracts/core/NullifierRegistryV3.sol
  Analyzed: 7 contracts, 95 detectors
  Results: 7
  - assembly: _hashPair
  - costly-loop: merkleRoot, rootHistoryIndex, totalNullifiers (x6 instances)

### contracts/privacy/UniversalShieldedPool.sol
  Analyzed: 14 contracts, 95 detectors
  Results: 9
  - arbitrary-send-eth: _safeTransferETH (access controlled — false positive)
  - missing-zero-check: setSanctionsOracle
  - costly-loop: _insertLeaf state updates (x3)
  - low-level-calls: _verifyWithdrawalProof, _verifyBatchProof,
    _checkSanctions, _safeTransferETH

### contracts/privacy/StealthAddressRegistry.sol
  Analyzed: 17 contracts, 95 detectors
  Results: 4
  - arbitrary-send-eth: withdrawFees (onlyOwner — false positive)
  - incorrect-equality: registerMetaAddress enum check
  - calls-loop: batchScan external calls
  - low-level-calls: withdrawFees

### contracts/privacy/ViewKeyRegistry.sol
  Analyzed: 17 contracts, 95 detectors
  Results: 2
  - incorrect-equality: getActiveGrantsReceived enum checks (x2)

### contracts/privacy/BatchAccumulator.sol
  Analyzed: 17 contracts, 95 detectors
  Results: 2
  - incorrect-equality: getAnonymitySet bytes32(0) check
  - low-level-calls: _verifyAggregateProof staticcall

### contracts/crosschain/ZaseonCrossChainRelay.sol
  Analyzed: (contracts, 95 detectors)
  Results: 3
  - low-level-calls: _sendViaLayerZero, _sendViaHyperlane, _submitToProofHub

### contracts/primitives/ZKBoundStateLocks.sol
  Analyzed: 10 contracts, 95 detectors
  Results: 4
  - cyclomatic-complexity: high complexity functions
  - low-level-calls: multiple instances

================================================================================
## Actionable Recommendations
================================================================================

1. **[O-1] Make DirectL2Messenger.zaseonHub immutable** — saves gas, low risk
2. **[M-8] Add zero-check in UniversalShieldedPool.setSanctionsOracle** — defense in depth
3. **[O-2..7] Cap batch sizes in NullifierRegistryV3** — prevent gas griefing
4. **[L-1] Move event before external call in ZaseonAtomicSwapV2.executeFeeWithdrawal** — best practice
5. **Index address params in FeeRecipientUpdated event** — improves log filtering

## Excluded from Analysis
- Generated verifier contracts (cause ConstantFolding crash)
- Test contracts, mocks, harnesses (filtered by config)
- OpenZeppelin / forge-std libraries (filtered by config)
